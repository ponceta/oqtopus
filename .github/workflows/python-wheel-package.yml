name: üêç Build Python Wheel

on:
  push:
    tags:
      - '*'
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
  workflow_call:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for setuptools-git-versioning

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install build tool
        run: python -m pip install --upgrade build

      - name: Bundle PyPI dependencies
        run: |
          while IFS= read -r line; do
            [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue
            pip download "$line" --no-deps --only-binary :all: -d temp/
          done < requirements-libs.txt
          unzip -o "temp/*.whl" -d oqtopus/libs
          touch oqtopus/libs/__init__.py
          rm -r temp

      - name: Build wheel
        run: python -m build

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: oqtopus-wheel
          path: dist/*
          if-no-files-found: error
